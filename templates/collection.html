<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ name }} - ChromaDBAdmin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="{{ url_for('index') }}">ChromaDBAdmin</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('index') }}">Collections</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="#">{{ name }}</a>
                    </li>
                </ul>
            </div>
            <div class="d-flex">
                <button class="btn btn-outline-light" data-bs-toggle="modal" data-bs-target="#queryModal">
                    <i class="bi bi-search"></i> Recherche sémantique
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row mb-4">
            <div class="col-md-6">
                <h2>{{ name }}</h2>
                <p>
                    <strong>Métadonnées:</strong>
                    <pre class="metadata-preview">{{ collection.metadata | tojson(indent=2) }}</pre>
                </p>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-success me-2" id="btn-refresh">
                    <i class="bi bi-arrow-clockwise"></i> Actualiser
                </button>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDocumentModal">
                    <i class="bi bi-plus-circle"></i> Ajouter un document
                </button>
            </div>
        </div>
        
        <div class="card mb-4 shadow">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">Filtrer les documents</h5>
            </div>
            <div class="card-body">
                <form id="filterForm" class="row g-3">
                    <div class="col-md-5">
                        <label for="whereFilter" class="form-label">Filtre par métadonnées (JSON)</label>
                        <input type="text" class="form-control" id="whereFilter" placeholder='{"category": "news"}'>
                    </div>
                    <div class="col-md-5">
                        <label for="whereDocumentFilter" class="form-label">Filtre par contenu (JSON)</label>
                        <input type="text" class="form-control" id="whereDocumentFilter" placeholder='{"$contains":"texte spécifique"}'>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <button type="submit" class="btn btn-primary w-100">Appliquer</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card shadow">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Documents</h5>
                <span id="document-count" class="badge bg-light text-dark">0 éléments</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="documentsTable">
                        <thead class="table-dark">
                            <tr>
                                <th class="resizable">ID<div class="resizer" data-column="0"></div></th>
                                <th class="resizable">Document<div class="resizer" data-column="1"></div></th>
                                <th class="resizable">Métadonnées<div class="resizer" data-column="2"></div></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="documentsTableBody">
                            <tr>
                                <td colspan="4" class="text-center">Chargement des documents...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <button class="btn btn-secondary" id="btn-prev-page" disabled>
                        <i class="bi bi-arrow-left"></i> Précédent
                    </button>
                    <span id="pagination-info">Page 1</span>
                    <button class="btn btn-secondary" id="btn-next-page">
                        Suivant <i class="bi bi-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Ajouter Document -->
    <div class="modal fade" id="addDocumentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ajouter un document</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addDocumentForm">
                        <div class="mb-3">
                            <label for="documentId" class="form-label">ID du document (optionnel)</label>
                            <input type="text" class="form-control" id="documentId" placeholder="Laissez vide pour un ID auto-généré">
                        </div>
                        <div class="mb-3">
                            <label for="documentText" class="form-label">Texte du document</label>
                            <textarea class="form-control" id="documentText" rows="5" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="documentMetadata" class="form-label">Métadonnées (JSON, optionnel)</label>
                            <textarea class="form-control" id="documentMetadata" rows="5">
{
    "source": "",
    "created_at": "{{ ''|now }}"
}
                            </textarea>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="generateEmbedding" checked>
                            <label class="form-check-label" for="generateEmbedding">
                                Générer l'embedding OpenAI
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="addDocumentBtn">Ajouter</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Modifier Document -->
    <div class="modal fade" id="editDocumentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modifier le document</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editDocumentForm">
                        <input type="hidden" id="editDocumentId">
                        <div class="mb-3">
                            <label for="editDocumentText" class="form-label">Texte du document</label>
                            <textarea class="form-control" id="editDocumentText" rows="5" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editDocumentMetadata" class="form-label">Métadonnées (JSON)</label>
                            <textarea class="form-control" id="editDocumentMetadata" rows="5"></textarea>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="editGenerateEmbedding" checked>
                            <label class="form-check-label" for="editGenerateEmbedding">
                                Regénérer l'embedding OpenAI
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="button" class="btn btn-primary" id="updateDocumentBtn">Mettre à jour</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Recherche Sémantique -->
    <div class="modal fade" id="queryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Recherche sémantique</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="queryForm">
                        <div class="mb-3">
                            <label for="queryText" class="form-label">Texte de la requête</label>
                            <textarea class="form-control" id="queryText" rows="3" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="numResults" class="form-label">Nombre de résultats</label>
                            <input type="number" class="form-control" id="numResults" value="10" min="1" max="100">
                        </div>
                        <div class="mb-3">
                            <label for="queryWhereFilter" class="form-label">Filtre par métadonnées (JSON, optionnel)</label>
                            <input type="text" class="form-control" id="queryWhereFilter" placeholder='{"category": "news"}'>
                        </div>
                    </form>
                    
                    <div id="queryResults" class="mt-4 d-none">
                        <h5>Résultats</h5>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>ID</th>
                                        <th>Document</th>
                                        <th>Métadonnées</th>
                                        <th>Distance</th>
                                    </tr>
                                </thead>
                                <tbody id="queryResultsBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="button" class="btn btn-primary" id="runQueryBtn">Exécuter la recherche</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script>
        $(document).ready(function() {
            const ITEMS_PER_PAGE = 20;
            let currentPage = 0;
            let whereFilter = null;
            let whereDocumentFilter = null;
            let totalCount = 0;
            
            // Charger les documents au chargement de la page
            loadDocuments();
            
            // Bouton Actualiser
            $("#btn-refresh").click(function() {
                loadDocuments();
            });
            
            // Pagination
            $("#btn-prev-page").click(function() {
                if (currentPage > 0) {
                    currentPage--;
                    loadDocuments();
                }
            });
            
            $("#btn-next-page").click(function() {
                if ((currentPage + 1) * ITEMS_PER_PAGE < totalCount) {
                    currentPage++;
                    loadDocuments();
                }
            });
            
            // Appliquer les filtres
            $("#filterForm").submit(function(e) {
                e.preventDefault();
                const whereInput = $("#whereFilter").val();
                const whereDocInput = $("#whereDocumentFilter").val();
                
                whereFilter = whereInput ? whereInput : null;
                whereDocumentFilter = whereDocInput ? whereDocInput : null;
                
                currentPage = 0;
                loadDocuments();
            });
            
            // Ajouter un document
            $("#addDocumentBtn").click(function() {
                const id = $("#documentId").val();
                const document = $("#documentText").val();
                const metadata = $("#documentMetadata").val();
                const generateEmbedding = $("#generateEmbedding").prop("checked");
                
                $.ajax({
                    url: "/collection/{{ name }}/document/add",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        id: id || null,
                        document: document,
                        metadata: JSON.parse(metadata),
                        generate_embedding: generateEmbedding
                    }),
                    success: function(response) {
                        $("#addDocumentModal").modal("hide");
                        loadDocuments();
                    },
                    error: function(xhr) {
                        alert("Erreur lors de l'ajout du document: " + xhr.responseText);
                    }
                });
            });
            
            // Modifier un document (ouvrir la modal avec les données)
            $(document).on("click", ".edit-document", function() {
                const row = $(this).closest("tr");
                const id = row.data("id");
                const document = row.data("document");
                const metadata = row.data("metadata");
                
                $("#editDocumentId").val(id);
                $("#editDocumentText").val(document);
                $("#editDocumentMetadata").val(JSON.stringify(metadata, null, 2));
                
                $("#editDocumentModal").modal("show");
            });
            
            // Mettre à jour un document
            $("#updateDocumentBtn").click(function() {
                const id = $("#editDocumentId").val();
                const document = $("#editDocumentText").val();
                const metadata = $("#editDocumentMetadata").val();
                const generateEmbedding = $("#editGenerateEmbedding").prop("checked");
                
                $.ajax({
                    url: `/collection/{{ name }}/document/${id}/update`,
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        document: document,
                        metadata: JSON.parse(metadata),
                        generate_embedding: generateEmbedding
                    }),
                    success: function(response) {
                        $("#editDocumentModal").modal("hide");
                        loadDocuments();
                    },
                    error: function(xhr) {
                        alert("Erreur lors de la mise à jour du document: " + xhr.responseText);
                    }
                });
            });
            
            // Supprimer un document
            $(document).on("click", ".delete-document", function() {
                const id = $(this).closest("tr").data("id");
                
                if (confirm(`Êtes-vous sûr de vouloir supprimer le document avec l'ID "${id}" ?`)) {
                    $.ajax({
                        url: `/collection/{{ name }}/document/${id}/delete`,
                        type: "POST",
                        success: function(response) {
                            loadDocuments();
                        },
                        error: function(xhr) {
                            alert("Erreur lors de la suppression du document: " + xhr.responseText);
                        }
                    });
                }
            });
            
            // Exécuter une recherche sémantique
            $("#runQueryBtn").click(function() {
                const queryText = $("#queryText").val();
                const numResults = $("#numResults").val();
                const whereFilter = $("#queryWhereFilter").val();
                
                $.ajax({
                    url: "/collection/{{ name }}/query",
                    type: "POST",
                    contentType: "application/json",
                    data: JSON.stringify({
                        query_text: queryText,
                        n_results: parseInt(numResults),
                        where: whereFilter ? JSON.parse(whereFilter) : null
                    }),
                    success: function(results) {
                        displayQueryResults(results);
                    },
                    error: function(xhr) {
                        alert("Erreur lors de l'exécution de la requête: " + xhr.responseText);
                    }
                });
            });
            
            // Fonction pour charger les documents
            function loadDocuments() {
                // D'abord obtenir le nombre total
                $.ajax({
                    url: `/collection/{{ name }}/count`,
                    type: "GET",
                    data: {
                        where: whereFilter,
                        where_document: whereDocumentFilter
                    },
                    success: function(response) {
                        totalCount = response.count;
                        $("#document-count").text(totalCount + " éléments");
                        
                        // Mettre à jour l'interface de pagination
                        updatePaginationUI();
                        
                        // Maintenant charger les documents pour la page actuelle
                        $.ajax({
                            url: `/collection/{{ name }}/documents`,
                            type: "GET",
                            data: {
                                where: whereFilter,
                                where_document: whereDocumentFilter,
                                limit: ITEMS_PER_PAGE,
                                offset: currentPage * ITEMS_PER_PAGE
                            },
                            success: function(documents) {
                                displayDocuments(documents);
                            },
                            error: function(xhr) {
                                alert("Erreur lors du chargement des documents: " + xhr.responseText);
                            }
                        });
                    },
                    error: function(xhr) {
                        alert("Erreur lors du comptage des documents: " + xhr.responseText);
                    }
                });
            }
            
            // Fonction pour afficher les documents
            function displayDocuments(documents) {
                const tbody = $("#documentsTableBody");
                tbody.empty();
                
                if (documents.length === 0) {
                    tbody.html('<tr><td colspan="4" class="text-center">Aucun document trouvé</td></tr>');
                    return;
                }
                
                documents.forEach(function(doc) {
                    const row = $("<tr>")
                        .data("id", doc.id)
                        .data("document", doc.document)
                        .data("metadata", doc.metadata);
                    
                    row.append($("<td>").text(doc.id));
                    
                    const docText = $("<td>");
                    if (doc.document && doc.document.length > 100) {
                        docText.html(`<div class="text-truncate">${doc.document.substring(0, 100)}...</div>
                                    <button class="btn btn-sm btn-link view-full-text">Voir le texte complet</button>`);
                    } else {
                        docText.text(doc.document || "");
                    }
                    row.append(docText);
                    
                    row.append($("<td>").html(`<pre class="metadata-preview">${JSON.stringify(doc.metadata || {}, null, 2)}</pre>`));
                    
                    const actions = $("<td>").html(`
                        <div class="d-grid gap-1">
                            <button class="btn btn-sm btn-warning edit-document">
                                <i class="bi bi-pencil"></i> Modifier
                            </button>
                            <button class="btn btn-sm btn-danger delete-document">
                                <i class="bi bi-trash"></i> Supprimer
                            </button>
                        </div>
                    `);
                    row.append(actions);
                    
                    tbody.append(row);
                });
            }
            
            // Fonction pour afficher les résultats de recherche
            function displayQueryResults(documents) {
                const tbody = $("#queryResultsBody");
                tbody.empty();
                
                if (documents.length === 0) {
                    tbody.html('<tr><td colspan="4" class="text-center">Aucun résultat trouvé</td></tr>');
                } else {
                    documents.forEach(function(doc) {
                        const row = $("<tr>");
                        
                        row.append($("<td>").text(doc.id));
                        row.append($("<td>").text(doc.document));
                        row.append($("<td>").html(`<pre class="metadata-preview">${JSON.stringify(doc.metadata, null, 2)}</pre>`));
                        row.append($("<td>").text(doc.distance ? doc.distance.toFixed(4) : "N/A"));
                        
                        tbody.append(row);
                    });
                }
                
                $("#queryResults").removeClass("d-none");
            }
            
            // Fonction pour mettre à jour l'interface de pagination
            function updatePaginationUI() {
                const startItem = currentPage * ITEMS_PER_PAGE + 1;
                const endItem = Math.min((currentPage + 1) * ITEMS_PER_PAGE, totalCount);
                
                $("#pagination-info").text(`Affichage ${startItem}-${endItem} sur ${totalCount}`);
                
                // Activer/désactiver les boutons de pagination
                $("#btn-prev-page").prop("disabled", currentPage === 0);
                $("#btn-next-page").prop("disabled", endItem === totalCount);
            }
            
            // Voir le texte complet
            $(document).on("click", ".view-full-text", function(e) {
                e.preventDefault();
                const row = $(this).closest("tr");
                const fullText = row.data("document");
                alert(fullText);
            });
            
            // Redimensionnement des colonnes
            const table = document.getElementById('documentsTable');
            const resizers = document.querySelectorAll('#documentsTable th .resizer');
            let currentResizer;
            
            // Largeurs initiales (en pourcentage)
            const colWidths = [10, 40, 40, 10];
            
            // Initialiser les largeurs
            function setInitialColWidths() {
                const tableWidth = table.offsetWidth;
                const ths = table.querySelectorAll('th');
                
                for (let i = 0; i < colWidths.length; i++) {
                    if (ths[i]) {
                        ths[i].style.width = `${colWidths[i]}%`;
                    }
                }
            }
            
            // Appliquer les largeurs initiales au chargement de la page
            setInitialColWidths();
            
            // Recalculer si la fenêtre est redimensionnée
            window.addEventListener('resize', setInitialColWidths);
            
            // Gérer le redimensionnement
            for (let i = 0; i < resizers.length; i++) {
                const resizer = resizers[i];
                
                resizer.addEventListener('mousedown', function(e) {
                    currentResizer = e.target;
                    const columnIndex = parseInt(currentResizer.getAttribute('data-column'));
                    const th = currentResizer.parentElement;
                    const nextTh = th.nextElementSibling;
                    
                    // Position initiale
                    const startPos = e.pageX;
                    const startWidthCurrent = th.offsetWidth;
                    const startWidthNext = nextTh ? nextTh.offsetWidth : 0;
                    
                    function onMouseMove(e) {
                        if (currentResizer) {
                            const diff = e.pageX - startPos;
                            
                            // Largeur minimum
                            const minWidth = 50;
                            
                            // Calculer nouvelles largeurs
                            let newWidthCurrent = Math.max(startWidthCurrent + diff, minWidth);
                            let newWidthNext = Math.max(startWidthNext - diff, minWidth);
                            
                            // Appliquer nouvelles largeurs
                            if (nextTh && newWidthNext >= minWidth) {
                                th.style.width = `${newWidthCurrent}px`;
                                nextTh.style.width = `${newWidthNext}px`;
                            }
                        }
                    }
                    
                    function onMouseUp() {
                        currentResizer = null;
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    }
                    
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                    
                    e.preventDefault();
                });
            }
        });
    </script>
</body>
</html>